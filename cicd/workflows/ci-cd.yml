name: Build and Trigger Infrastructure Update

on:
  # ãƒ¡ã‚¤ãƒ³ã¨é–‹ç™ºãƒ–ãƒ©ãƒ³ãƒã¸ã®pushã€ã¾ãŸã¯ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã§å®Ÿè¡Œ
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

env:
  AWS_REGION: ap-northeast-1
  ECR_REPOSITORY: laravel-app

jobs:
  # PHP/Laravel ãƒ†ã‚¹ãƒˆ: ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®å¥å…¨æ€§ã‚’æ¤œè¨¼
  php-tests:
    name: "PHP/Laravel Tests"
    runs-on: ubuntu-latest
    
    # ãƒ†ã‚¹ãƒˆç’°å¢ƒã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: laravel_test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup PHP and Composer
      uses: shivammathur/setup-php@v2
      with:
        php-version: '8.2'
        extensions: dom, curl, libxml, mbstring, zip, pcntl, pdo, pdo_pgsql, bcmath, soap, intl, gd, exif, iconv, imagick, mecab
        coverage: xdebug
    
    - name: Cache Composer dependencies
      uses: actions/cache@v3
      with:
        path: ~/.composer/cache/files
        key: composer-${{ hashFiles('composer.lock') }}
        restore-keys: composer-
    
    - name: Install Composer dependencies
      run: composer install --no-interaction --prefer-dist --optimize-autoloader
    
    - name: Prepare environment
      run: |
        cp .env.example .env
        php artisan key:generate
        echo "DB_CONNECTION=pgsql" >> .env
        echo "DB_HOST=127.0.0.1" >> .env
        echo "DB_PORT=5432" >> .env
        echo "DB_DATABASE=laravel_test" >> .env
        echo "DB_USERNAME=postgres" >> .env
        echo "DB_PASSWORD=postgres" >> .env
    
    - name: Run database migrations
      run: php artisan migrate --force
    
    - name: Run static analysis (PHPStan)
      run: vendor/bin/phpstan analyse
    
    - name: Run unit tests (PHPUnit)
      run: vendor/bin/phpunit --coverage-clover coverage.xml

  # ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ãƒ»SSRãƒ†ã‚¹ãƒˆ: Vue.jsã¨Inertiaã®ãƒ“ãƒ«ãƒ‰ã¨ãƒ†ã‚¹ãƒˆ
  frontend-ssr-tests:
    name: "Frontend & SSR Tests"
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
    
    - name: Install Node.js dependencies
      run: npm ci
    
    - name: Run linter (ESLint) and formatter (Prettier) checks
      run: |
        npm run lint
        npm run format:check
    
    - name: Run TypeScript check
      run: npm run type-check
    
    - name: Build client assets
      run: npm run build
    
    - name: Build SSR bundle
      run: npm run build:ssr
    
    - name: Verify build outputs
      run: |
        if [ ! -d "public/build" ]; then
          echo "âŒ Client build failed - public/build not found"
          exit 1
        fi
        if [ ! -f "bootstrap/ssr/ssr.js" ]; then
          echo "âŒ SSR build failed - bootstrap/ssr/ssr.js not found"
          exit 1
        fi
        echo "âœ… Both client and SSR builds successful"
        ls -la public/build/
        ls -la bootstrap/ssr/
    
    - name: Test SSR bundle execution
      run: |
        cd bootstrap/ssr
        echo "ğŸ§ª Testing SSR bundle..."
        timeout 5s node ssr.js || [[ $? == 124 ]] && echo "âœ… SSR bundle executable" || echo "âŒ SSR bundle failed"

  # ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ç›£æŸ»: ä¾å­˜é–¢ä¿‚ã®è„†å¼±æ€§ã‚’ãƒã‚§ãƒƒã‚¯
  security-audit:
    name: "Security Audit"
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: '8.2'
    
    - name: Install Composer dependencies
      run: composer install --no-interaction --prefer-dist --optimize-autoloader
    
    - name: Run Composer security audit
      run: composer audit
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
    
    - name: Install Node.js dependencies
      run: npm ci
    
    - name: Run npm audit
      run: npm audit --audit-level=high

  # Dockerã‚¤ãƒ¡ãƒ¼ã‚¸ã®ãƒ“ãƒ«ãƒ‰ãƒ»ãƒ—ãƒƒã‚·ãƒ¥ã€ãŠã‚ˆã³ãƒ‡ãƒ—ãƒ­ã‚¤ã®ãƒˆãƒªã‚¬ãƒ¼
  # ã™ã¹ã¦ã®ãƒ†ã‚¹ãƒˆãŒæˆåŠŸã—ãŸå ´åˆã«ã®ã¿å®Ÿè¡Œ
  build-push-and-deploy:
    name: "Build, Push & Trigger Deployment"
    needs: [php-tests, frontend-ssr-tests, security-audit]
    runs-on: ubuntu-latest
    # pushã‚¤ãƒ™ãƒ³ãƒˆæ™‚ã®ã¿ãƒ‡ãƒ—ãƒ­ã‚¤ã‚’ãƒˆãƒªã‚¬ãƒ¼
    if: github.event_name == 'push'
    
    outputs:
      image-uri: ${{ steps.image.outputs.image-uri }}
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}

    - name: Login to Amazon ECR
      id: login-ecr
      uses: aws-actions/amazon-ecr-login@v2

    - name: Build, tag, and push image to Amazon ECR
      id: build-image
      env:
        ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
        IMAGE_TAG: ${{ github.sha }}
      run: |
        echo "ğŸ”¨ Building Docker image with SSR support..."
        
        # Dockerã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ãƒ“ãƒ«ãƒ‰
        docker build \
          --build-arg BUILDKIT_INLINE_CACHE=1 \
          --cache-from $ECR_REGISTRY/$ECR_REPOSITORY:latest \
          -t $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG \
          -t $ECR_REGISTRY/$ECR_REPOSITORY:latest \
          .
        
        echo "ğŸ“¦ Pushing images to ECR..."
        docker push $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG
        docker push $ECR_REGISTRY/$ECR_REPOSITORY:latest
        
        echo "âœ… Image pushed successfully"
        echo "image-uri=$ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG" >> $GITHUB_OUTPUT

    - name: Verify image contents
      env:
        ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
        IMAGE_TAG: ${{ github.sha }}
      run: |
        echo "ğŸ” Verifying built image contents..."
        docker run --rm $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG ls -la /var/www/public/build/
        docker run --rm $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG ls -la /var/www/bootstrap/ssr/
        echo "âœ… Image verification completed"

    - name: Set image URI output
      id: image
      run: |
        echo "image-uri=${{ steps.build-image.outputs.image-uri }}" >> $GITHUB_OUTPUT

    # Terraformãƒªãƒã‚¸ãƒˆãƒªã«repository_dispatchã‚’é€ä¿¡ã—ã€ã‚¤ãƒ³ãƒ•ãƒ©ãƒ‡ãƒ—ãƒ­ã‚¤ã‚’ãƒˆãƒªã‚¬ãƒ¼
    # ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãƒªãƒã‚¸ãƒˆãƒªã¯ãƒ“ãƒ«ãƒ‰ã®è²¬ä»»ã®ã¿ã‚’è² ã„ã€ãƒ‡ãƒ—ãƒ­ã‚¤ã¯ã‚¤ãƒ³ãƒ•ãƒ©ãƒªãƒã‚¸ãƒˆãƒªã«å§”è­²
    - name: Trigger Infrastructure Deployment
      uses: actions/github-script@v7
      with:
        github-token: ${{ secrets.IAC_REPO_PAT }}
        script: |
          const imageUri = "${{ steps.image.outputs.image-uri }}";
          const branch = context.ref.replace('refs/heads/', '');
          const repository = context.repo.repo;
          const commitSha = context.sha;
          
          console.log('ğŸš€ Triggering infrastructure deployment...');
          console.log(`Image URI: ${imageUri}`);
          console.log(`Branch: ${branch}`);
          console.log(`Repository: ${repository}`);
          console.log(`Commit SHA: ${commitSha}`);
          
          await github.rest.repos.createDispatchEvent({
            owner: '${{ secrets.IAC_REPO_OWNER }}',
            repo: '${{ secrets.IAC_REPO_NAME }}',
            event_type: 'ecr-image-updated',
            client_payload: {
              container_image: imageUri,
              branch: branch,
              repository: repository,
              commit_sha: commitSha,
              triggered_at: new Date().toISOString(),
              trigger_workflow_run_id: '${{ github.run_id }}'
            }
          });
          
          console.log('âœ… Infrastructure deployment triggered successfully');

    # ãƒ“ãƒ«ãƒ‰çµæœã®é€šçŸ¥ï¼ˆGitHubã‚³ãƒ¡ãƒ³ãƒˆã¨Slackï¼‰
    # ãƒ‡ãƒ—ãƒ­ã‚¤ã¯ã‚¤ãƒ³ãƒ•ãƒ©ãƒªãƒã‚¸ãƒˆãƒªã§é€²è¡Œã™ã‚‹ãŸã‚ã€ã“ã“ã§ã¯ãƒ“ãƒ«ãƒ‰ã®æˆåŠŸ/å¤±æ•—ã®ã¿ã‚’é€šçŸ¥
    - name: Notify build completion
      if: always()
      uses: actions/github-script@v7
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        script: |
          const status = '${{ job.status }}';
          const environment = '${{ github.ref == "refs/heads/main" && "Production" || "Staging" }}';
          const imageUri = '${{ steps.image.outputs.image-uri }}';
          const commitUrl = `${context.payload.repository.html_url}/commit/${context.sha}`;
          
          if (status === 'success') {
            github.rest.repos.createCommitComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              commit_sha: context.sha,
              body: `ğŸ“¦ **Application Build Successful!**\n\n` +
                      `âœ… **Status:** Build and ECR push completed\n` +
                      `ğŸ–¼ï¸ **Image:** \`${imageUri}\`\n` +
                      `ğŸŒ **Target Environment:** ${environment}\n` +
                      `ğŸš€ **Infrastructure Deployment:** Triggered\n` +
                      `â±ï¸ **Built at:** ${new Date().toISOString()}\n\n` +
                      `Infrastructure deployment is now in progress. You'll receive another notification when complete.\n\n` +
                      `[View commit](${commitUrl})`
            });
          } else {
            github.rest.repos.createCommitComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              commit_sha: context.sha,
              body: `âŒ **Application Build Failed!**\n\n` +
                      `ğŸš¨ **Status:** Build or ECR push encountered errors\n` +
                      `ğŸŒ **Target Environment:** ${environment}\n` +
                      `ğŸ” **Logs:** [View workflow run](${context.payload.repository.html_url}/actions/runs/${context.runId})\n` +
                      `â±ï¸ **Failed at:** ${new Date().toISOString()}\n\n` +
                      `Please check the workflow logs for detailed error information.`
            });
          }

    - name: Slack build notification
      if: always() && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop')
      uses: 8398a7/action-slack@v3
      with:
        status: ${{ job.status }}
        text: |
          ${{ job.status == 'success' && 'ğŸ“¦' || 'âŒ' }} ${{ github.ref == 'refs/heads/main' && 'Production' || 'Staging' }} Build ${{ job.status == 'success' && 'Successful' || 'Failed' }}
          
          ğŸ–¼ï¸ Image: ${{ steps.image.outputs.image-uri }}
          ğŸŒ Repository: ${{ github.repository }}
          ğŸ”— Commit: ${{ github.sha }}
          ${{ job.status == 'success' && 'ğŸš€ Infrastructure deployment triggered' || 'ğŸš¨ Build failed - no deployment triggered' }}
        webhook_url: ${{ secrets.SLACK_WEBHOOK }}